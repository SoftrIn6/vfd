<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - SOFT RINVESTMENT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
       /* Reset & Base Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    background-color: #f8f9fa;
    color: #333;
    line-height: 1.5;
    overflow-x: hidden;
}

/* Container */
.container {
    width: 100%;
    max-width: 700px;
    margin: 0 auto;
    padding: 0 15px;
    position: relative;
    background-color: #fff;
    min-height: 100vh;
}

/* Header Styles */
.header {
    padding: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #fff;
}

.logo {
    display: flex;
    align-items: center;
}

.logo-img {
    width: 35px;
    height: 35px;
    margin-right: 8px;
}

.logo-text {
    font-size: 10px;
    font-weight: bold;
    color: #333;
}

.header-btns {
    display: flex;
    gap: 8px;
}

.header-btn {
    display: flex;
    align-items: center;
    background-color: #fff;
    border-radius: 20px;
    padding: 4px 10px;
    font-size: 10px;
    color: #ffa500;
    border: 1px solid #ffa500;
}

.header-btn.app {
    background-color: #ffa500;
    color: #fff;
}

/* User Profile */
.user-profile {
    padding: 15px;
    background-color: #fff;
    display: flex;
    align-items: center;
}

.user-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
}

.user-avatar i {
    font-size: 24px;
    color: #ffa500;
}

.user-info {
    flex: 1;
    color: #ffa500;
}

.user-copy {
    margin-left: 10px;
    color: #ffa500;
    cursor: pointer;
}

/* Assets Section */
.assets-section {
    margin: 10px;
    padding: 15px;
    background-color: #fff;
    border-radius: 10px;
}

.section-title {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 12px;
}

.total-assets {
    font-size: 22px;
    font-weight: bold;
    color: #ffa500;
    margin-bottom: 15px;
}

.assets-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.asset-item {
    padding: 12px;
    background-color: #f9f9f9;
    border-radius: 10px;
}

.asset-label {
    font-size: 14px;
    color: #ffa500;
    margin-bottom: 8px;
}

.asset-value {
    font-size: 16px;
    font-weight: bold;
}

/* Action Buttons */
.action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin: 10px;
}

.action-btn {
    padding: 12px;
    background-color: #ffa500;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    text-align: center;
}

/* Revenue Section */
.revenue-section {
    margin: 10px;
    padding: 15px;
    background-color: #fff;
    border-radius: 10px;
}

.revenue-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 12px;
}

.revenue-item {
    padding: 12px;
    background-color: #f9f9f9;
    border-radius: 10px;
}

/* Activity Section */
.activity-section {
    margin: 10px;
    padding: 15px;
    background-color: #fff;
    border-radius: 10px;
}

.activity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.activity-filters {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.activity-filter {
    padding: 5px 10px;
    background-color: #f0f0f0;
    border-radius: 15px;
    font-size: 12px;
    cursor: pointer;
}

.activity-filter.active {
    background-color: #ffa500;
    color: white;
}

.activity-list {
    max-height: 400px;
    overflow-y: auto;
}

.activity-item {
    padding: 12px;
    border-bottom: 1px solid #f0f0f0;
    position: relative;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-time {
    font-size: 12px;
    color: #999;
    margin-bottom: 5px;
}

.activity-title {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 5px;
}

.activity-details {
    font-size: 13px;
    color: #666;
}

.activity-status {
    position: absolute;
    top: 12px;
    right: 12px;
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 10px;
}

.activity-status.success {
    background-color: #e6f7ee;
    color: #4cd964;
}

.activity-status.failed {
    background-color: #ffeeee;
    color: #ff3b30;
}

.activity-status.pending {
    background-color: #fff8e1;
    color: #ffa500;
}

.activity-empty {
    text-align: center;
    padding: 20px;
    color: #999;
    font-style: italic;
}

.activity-load-more {
    text-align: center;
    padding: 10px;
    color: #ffa500;
    cursor: pointer;
    font-weight: bold;
}

/* App Services */
.services-section {
    margin: 10px;
    padding: 15px;
    background-color: #fff;
    border-radius: 10px;
}

.service-title {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 12px;
    position: relative;
}

.service-title::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    width: 30px;
    height: 3px;
    background-color: #ffa500;
}

.service-list {
    margin-top: 15px;
}

.service-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
}

.service-item:last-child {
    border-bottom: none;
}

.service-icon {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background-color: #fff8e1;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    color: #ffa500;
}

.service-info {
    flex: 1;
    display: flex;
    align-items: center;
}

.service-name {
    font-size: 14px;
}

.service-arrow {
    color: #ccc;
}

/* Sign Out Button */
.sign-out-btn {
  margin: 0px 10px 11px 10px; /* top, right, bottom, left */
    padding: 12px;
    background-color: #ffa500;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    width: calc(100% - 30px);
    cursor: pointer;
    text-align: center;
}

/* Float button */
.float-btn {
    position: fixed;
    bottom: 60px;
    right: 15px;
    width: 35px;
    height: 35px;
    background-color: #ffa500;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    z-index: 100;
    cursor: pointer;
}

/* Bottom Navigation */
.bottom-nav {
   width: 100%;
    max-width: 700px;
    margin: 0 auto;
    padding: 0 15px;
    position: relative;
    background-color: #fff;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    padding: 8px 0;
    border-top: 1px solid #eee;
    z-index: 100;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-decoration: none;
    color: #999;
    font-size: 10px;
}

.nav-item.active {
    color: #ffa500;
}

.nav-item i {
    font-size: 18px;
    margin-bottom: 5px;
}
/* Features Grid */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 15px;
            background-color: #fff;
        }

        .feature-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #333;
        }

        .feature-icon {
            width: 50px;
            height: 50px;
            margin-bottom: 5px;
            object-fit: contain;
        }

        .feature-name {
            font-size: 12px;
            text-align: center;
        }
/* Media Queries for Responsiveness */
@media (max-width: 470px) {
    .container {
        padding-left: 10px;
        padding-right: 10px;
    }

    .section-title,
    .total-assets,
    .asset-label,
    .asset-value,
    .service-name {
        font-size: 12px;
    }

    .action-btn {
        font-size: 12px;
        padding: 10px;
    }

    .sign-out-btn {
        font-size: 14px;
        padding: 10px;
    }

    .nav-item {
        font-size: 8px;
    }

    .nav-item i {
        font-size: 16px;
    }

    .features-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .activity-filters {
        flex-wrap: wrap;
    }
    
    .activity-filter {
        font-size: 10px;
        padding: 4px 8px;
    }
}

    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <img src="image/4e0ab918-1d65-40ac-9762-0ad78571cc2c.png?height=40&width=40" alt="Logo" class="logo-img" style="background: linear-gradient(45deg, #ff6b6b, #ffa500); border-radius: 50%;">
                <div class="logo-text">SOFT RINVESTMENT</div>
            </div>
          <div class="header-btns">
                <a href="https://softrinvestment.com/download-app.html">
                <div class="header-btn app">
                <i class="fas fa-mobile-alt"></i> App
    </div>
</a>
                <div class="header-btn">
                    <i class="fas fa-globe"></i> English
                </div>
            </div>
        </div>

        <!-- User Profile -->
        <div class="user-profile">
            <div class="user-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="user-info">
                <div style="font-size: 18px; font-weight: bold;" id="username"></div>
                <div style="color: #666; margin-top: 5px;" id="user-email"></div>
                <i class="fas fa-copy user-copy" id="copy-email"></i>
            </div>
        </div>

        <!-- Assets Section -->
        <div class="assets-section">
            <div class="section-title">Total Account Balance</div>
            <div class="total-assets" id="total-assets">$0.00</div>
            <div class="assets-grid">
                <div class="asset-item">
                    <div class="asset-label">New Deposit</div>
                    <div class="asset-value" id="quantitative-account">$0.00</div>
                </div>
                <div class="asset-item">
                    <div class="asset-label">Today's Earnings</div>
                    <div class="asset-value" id="smart-account">$0.00</div>
                </div>
                <div class="asset-item">
                    <div class="asset-label">Registration Bonus</div>
                    <div class="asset-value" id="profit-assets">$0.00</div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <div class="action-btn" id="recharge-btn">Recharge</div>
            <div class="action-btn" id="withdraw-btn">Withdraw</div>
        </div>

        <!-- Revenue Section -->
        <div class="revenue-section">
            <div class="section-title">Total Withdrawals Made</div>
            <div class="total-assets" id="total-revenue">$0.00</div>
            <div class="revenue-grid">
                <div class="asset-item">
                    <div class="asset-label">Yesterday's Earnings</div>
                    <div class="asset-value" id="yesterday-earnings">$0.00</div>
                </div>
                <div class="asset-item">
                    <div class="asset-label">Smart Balance</div>
                    <div class="asset-value" id="today-earnings">$0.00</div>
                </div>
                <div class="asset-item">
                    <div class="asset-label">Task Earnings </div>
                    <div class="asset-value" id="commission-today">$0.00</div>
                </div>
            </div>
        </div>

        <!-- Activity Section (New) -->
        <div class="activity-section">
            <div class="activity-header">
                <div class="section-title">Account Activity</div>
                <div id="activity-export" style="font-size: 12px; color: #ffa500; cursor: pointer;">
                    <i class="fas fa-download"></i> Export
                </div>
            </div>
            
            <div class="activity-filters">
                <div class="activity-filter active" data-filter="all">All</div>
                <div class="activity-filter" data-filter="withdrawal">Withdrawals</div>
                <div class="activity-filter" data-filter="investment">Investments</div>
                <div class="activity-filter" data-filter="authentication">Login/Auth</div>
                <div class="activity-filter" data-filter="ui_interaction">Interactions</div>
            </div>
            
            <div class="activity-list" id="activity-list">
                <!-- Activity items will be generated by JavaScript -->
                <div class="activity-empty">Loading activity data...</div>
            </div>
            
            <div class="activity-load-more" id="activity-load-more" style="display: none;">
                Load More
            </div>
        </div>

        <!-- Features Grid -->
        <div class="features-grid">
            <a href="recharge.html" class="feature-item" id="recharge">
                <img src="image/icons8-stack-of-coins.gif?height=50&width=50" alt="Recharge" class="feature-icon" style="background-color: #fff; border-radius: 10px;">
                <div class="feature-name">Fund Account</div>
            </a>
            <a href="withdraw.html" class="feature-item" id="withdraw">
                <img src="image/icons8-coins.gif?height=50&width=50" alt="Withdraw" class="feature-icon" style="background-color: #fff; border-radius: 10px;">
                <div class="feature-name">Withdraw</div>
            </a>
            <a href="help-center.html" class="feature-item" id="help">
                <img src="image/icons8-online-support (1).gif?height=50&width=50" alt="Help" class="feature-icon" style="background-color: #fff; border-radius: 10px;">
                <div class="feature-name">Help</div>
            </a>
            <a href="reviews.html" class="feature-item" id="team">
                <img src="image/icons8-comments.gif?height=50&width=50" alt="Team" class="feature-icon" style="background-color: #fff; border-radius: 10px;">
                <div class="feature-name">Exchange</div>
            </a>
        </div>
        
        <!-- App Services -->
        <div class="services-section">
    <div class="service-title">App Services</div>
    <div class="service-list">
        <a href="https://softrinvestment.com/help-center.html" class="service-item" id="detail-service">
            <div class="service-info">
                <div class="service-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="service-name">Help</div>
            </div>
            <div class="service-arrow">
                <i class="fas fa-chevron-right"></i>
            </div>
        </a>

        <a href="https://softrinvestment.com/how-to-invest.html" class="service-item" id="transfer-service">
            <div class="service-info">
                <div class="service-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <div class="service-name">How to Invest</div>
            </div>
            <div class="service-arrow">
                <i class="fas fa-chevron-right"></i>
            </div>
        </a>

        <a href="https://softrinvestment.com/faq.html" class="service-item" id="news-service">
            <div class="service-info">
                <div class="service-icon">
                    <i class="fas fa-newspaper"></i>
                </div>
                <div class="service-name">Frequently Asked Questions</div>
            </div>
            <div class="service-arrow">
                <i class="fas fa-chevron-right"></i>
            </div>
        </a>

        <a href="https://softrinvestment.com/invest.html" class="service-item" id="security-service">
            <div class="service-info">
                <div class="service-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <div class="service-name">Investment Plan</div>
            </div>
            <div class="service-arrow">
                <i class="fas fa-chevron-right"></i>
            </div>
        </a>

        <a href="https://softrinvestment.com/sharing-task.html" class="service-item" id="tutorial-service">
            <div class="service-info">
                <div class="service-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="service-name">Tasks</div>
            </div>
            <div class="service-arrow">
                <i class="fas fa-chevron-right"></i>
            </div>
        </a>

        <a href="https://softrinvestment.com/contact-us.html" class="service-item" id="problem-service">
            <div class="service-info">
                <div class="service-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <div class="service-name">Contact Us</div>
            </div>
            <div class="service-arrow">
                <i class="fas fa-chevron-right"></i>
            </div>
        </a>

        <a href="https://softrinvestment.com/about-us.html" class="service-item" id="about-service">
            <div class="service-info">
                <div class="service-icon">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div class="service-name">About Us</div>
            </div>
            <div class="service-arrow">
                <i class="fas fa-chevron-right"></i>
            </div>
        </a>
    </div>
</div>


        <!-- Sign Out Button -->
        <div class="sign-out-btn" id="sign-out-btn">Sign Out</div>

        <!-- Float Button -->
        <div class="float-btn" id="refresh-btn">
            <i class="fas fa-arrow-up"></i>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="sharing-task.html" class="nav-item">
            <i class="fas fa-chart-pie"></i>
            <span>Task</span>
        </a>
        <a href="invest.html" class="nav-item">
            <i class="fas fa-gift"></i>
            <span>Invest</span>
        </a>
        <a href="invite-friends.html" class="nav-item">
            <i class="fas fa-user-plus"></i>
            <span>Invite Friends</span>
        </a>
        <a href="profile.html" class="nav-item active">
            <i class="fas fa-user"></i>
            <span>Me</span>
        </a>
    </nav>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // Constants
        const USER_ACTIVITY_KEY = 'userActivityHistory';
        const ACTIVITY_RETENTION_DAYS = 7;
        
        // Baserow API configuration
        const BASEROW_API = {
            token: '6u6gYOsipnV3NwAkcKpGn4D6bsZbEk1M',
            baseUrl: 'https://api.baserow.io/api',
            databaseId: '202237',
            tableId: '488473',
            activityTableId: '488474' // New table ID for account_activity
        };

        // Check if user is logged in when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const authToken = localStorage.getItem('authToken');
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            
            if (!authToken || !userData.email) {
                // Redirect to login page if not logged in
                window.location.href = 'login.html';
                return;
            }
            
            // Initialize UI with cached data first
            if (userData) {
                updateUI(userData);
            }
            
            // Fetch fresh user data from Baserow
            fetchUserData(userData.email);
            
            // Load user activity history
            loadActivityHistory();
            
            // Set up activity filters
            setupActivityFilters();
            
            // Set up activity export
            setupActivityExport();
            
            // Set up refresh interval (every 30 seconds)
            setInterval(() => {
                const currentUserData = JSON.parse(localStorage.getItem('userData') || '{}');
                if (currentUserData.email) {
                    fetchUserData(currentUserData.email);
                    
                    // Also refresh activity data
                    loadActivityHistory();
                }
            }, 30000);
            
            // Copy email functionality
            document.getElementById('copy-email').addEventListener('click', function() {
                const email = document.getElementById('user-email').textContent;
                navigator.clipboard.writeText(email)
                    .then(() => {
                        alert('Email copied to clipboard!');
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                    });
            });
            
            // Sign out functionality
            document.getElementById('sign-out-btn').addEventListener('click', function() {
                if (confirm('Are you sure you want to sign out?')) {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userData');
                    window.location.href = 'login.html';
                }
            });
            
            // Action buttons functionality
            document.getElementById('recharge-btn').addEventListener('click', function() {
                window.location.href = 'recharge.html';
            });
            
            document.getElementById('withdraw-btn').addEventListener('click', function() {
                window.location.href = 'withdraw.html';
            });
            
            // Service items functionality
            document.querySelectorAll('.service-item').forEach(item => {
                item.addEventListener('click', function() {
                    const serviceId = this.id;
                    // No need for alert as these are now proper links
                });
            });
            
            // Refresh button functionality
            document.getElementById('refresh-btn').addEventListener('click', function() {
                // Scroll to top
                window.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
                
                // Force data refresh
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                if (userData.email) {
                    fetchUserData(userData.email, true);
                    
                    // Also refresh activity data
                    loadActivityHistory(true);
                }
            });
            
            // Clean up old activities (older than 7 days)
            cleanupOldActivities();
        });
        
        // Fetch user data from Baserow
        async function fetchUserData(email, forceRefresh = false) {
            try {
                // First, get the field structure from Baserow
                const fieldsResponse = await fetch(`${BASEROW_API.baseUrl}/database/fields/table/${BASEROW_API.tableId}/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${BASEROW_API.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const fieldsData = await fieldsResponse.json();
                console.log('Baserow fields:', fieldsData);
                
                // Create a mapping of field names to their IDs
                const fieldMap = {};
                fieldsData.forEach(field => {
                    fieldMap[field.name] = field.id;
                });
                
                console.log('Field mapping:', fieldMap);
                
                // Get the email field ID
                const emailFieldId = fieldMap['email'];
                
                if (!emailFieldId) {
                    throw new Error('Email field not found in Baserow table');
                }
                
                // Add a timestamp to prevent caching
                const timestamp = new Date().getTime();
                const url = `${BASEROW_API.baseUrl}/database/rows/table/${BASEROW_API.tableId}/?filter__field_${emailFieldId}__equal=${encodeURIComponent(email)}&_=${timestamp}`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${BASEROW_API.token}`,
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Fetched user data response:', data);
                
                if (data.results && data.results.length > 0) {
                    const user = data.results[0];
                    console.log('Found user:', user);
                    
                    // Create a user data object to store in localStorage
                    const userDataToStore = {
                        id: user.id,
                        username: user[`field_${fieldMap['username']}`] || email.split('@')[0],
                        email: email,
                        referralCode: user[`field_${fieldMap['referralCode']}`] || '',
                        total_assets: user[`field_${fieldMap['total_assets']}`] || '0.00',
                        quantitative_account: user[`field_${fieldMap['quantitative_account']}`] || '0.00',
                        smart_account: user[`field_${fieldMap['smart_account']}`] || '0.00',
                        profit_assets: user[`field_${fieldMap['profit_assets']}`] || '5.00',
                        total_revenue: user[`field_${fieldMap['total_revenue']}`] || '0.00',
                        yesterday_earnings: user[`field_${fieldMap['yesterday_earnings']}`] || '0.00',
                        today_earnings: user[`field_${fieldMap['today_earnings']}`] || '0.00',
                        commission_today: user[`field_${fieldMap['commission_today']}`] || '0.00'
                    };
                    
                    console.log('User data to store:', userDataToStore);
                    
                    // Save to localStorage
                    localStorage.setItem('userData', JSON.stringify(userDataToStore));
                    
                    // Update UI with user data
                    updateUI(userDataToStore);
                    
                    if (forceRefresh) {
                        alert('Data refreshed successfully!');
                    }
                    
                    return userDataToStore;
                } else {
                    console.error('No user data found for email:', email);
                    
                    if (forceRefresh) {
                        alert('No user data found. Please try again or contact support.');
                    }
                    
                    return null;
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
                
                if (forceRefresh) {
                    alert('Failed to refresh data. Please try again.');
                }
                
                return null;
            }
        }
        
        // Update UI with user data
        function updateUI(userData) {
            // Update username and email
            document.getElementById('username').textContent = userData.username || userData.email.split('@')[0];
            document.getElementById('user-email').textContent = userData.email;
            
            // Log all financial data for debugging
            console.log('Financial data:', {
                total_assets: userData.total_assets,
                quantitative_account: userData.quantitative_account,
                smart_account: userData.smart_account,
                profit_assets: userData.profit_assets,
                total_revenue: userData.total_revenue,
                yesterday_earnings: userData.yesterday_earnings,
                today_earnings: userData.today_earnings,
                commission_today: userData.commission_today
            });
            
            // Update financial data
            updateFinancialValue('total-assets', userData.total_assets);
            updateFinancialValue('quantitative-account', userData.quantitative_account);
            updateFinancialValue('smart-account', userData.smart_account);
            updateFinancialValue('profit-assets', userData.profit_assets);
            
            updateFinancialValue('total-revenue', userData.total_revenue);
            updateFinancialValue('yesterday-earnings', userData.yesterday_earnings);
            updateFinancialValue('today-earnings', userData.today_earnings);
            updateFinancialValue('commission-today', userData.commission_today);
        }
        
        // Helper function to update financial values
        function updateFinancialValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (element) {
                // Format the value
                let formattedValue = '0.00';
                
                if (value !== undefined && value !== null && value !== '') {
                    // If it's a number or a string that can be converted to a number
                    if (!isNaN(parseFloat(value))) {
                        formattedValue = parseFloat(value).toFixed(2);
                    } else {
                        formattedValue = value;
                        // If it doesn't have decimal places, add them
                        if (!formattedValue.includes('.')) {
                            formattedValue += '.00';
                        }
                    }
                }
                
                // Update the element
                element.textContent = '$' + formattedValue;
            }
        }
        
        // Load activity history from localStorage
        function loadActivityHistory(forceRefresh = false) {
            const activityList = document.getElementById('activity-list');
            const activities = JSON.parse(localStorage.getItem(USER_ACTIVITY_KEY) || '[]');
            
            // Filter activities to only show those from the last 7 days
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - ACTIVITY_RETENTION_DAYS);
            
            const recentActivities = activities.filter(activity => {
                const activityDate = new Date(activity.timestamp);
                return activityDate >= sevenDaysAgo;
            });
            
            // Get current filter
            const currentFilter = document.querySelector('.activity-filter.active').dataset.filter;
            
            // Filter activities based on selected filter
            let filteredActivities = recentActivities;
            if (currentFilter !== 'all') {
                filteredActivities = recentActivities.filter(activity => {
                    if (currentFilter === 'withdrawal') {
                        return activity.type === 'withdrawal_request' || 
                               (activity.type === 'form_submission' && activity.details?.status);
                    } else if (currentFilter === 'investment') {
                        return activity.type === 'investment_attempt' || 
                               activity.type === 'investment_processing';
                    } else if (currentFilter === 'authentication') {
                        return activity.type === 'authentication' || 
                               activity.type === 'authentication_check';
                    } else if (currentFilter === 'ui_interaction') {
                        return activity.type === 'ui_interaction';
                    }
                    return false;
                });
            }
            
            // Clear the activity list
            activityList.innerHTML = '';
            
            // Display activities or empty message
            if (filteredActivities.length === 0) {
                activityList.innerHTML = '<div class="activity-empty">No activities found for the selected filter.</div>';
                document.getElementById('activity-load-more').style.display = 'none';
                return;
            }
            
            // Display first 10 activities
            const activitiesToShow = filteredActivities.slice(0, 10);
            activitiesToShow.forEach(activity => {
                const activityItem = createActivityItem(activity);
                activityList.appendChild(activityItem);
            });
            
            // Show/hide load more button
            if (filteredActivities.length > 10) {
                document.getElementById('activity-load-more').style.display = 'block';
                document.getElementById('activity-load-more').onclick = () => {
                    // Show next 10 activities
                    const currentCount = activityList.querySelectorAll('.activity-item').length;
                    const nextActivities = filteredActivities.slice(currentCount, currentCount + 10);
                    
                    nextActivities.forEach(activity => {
                        const activityItem = createActivityItem(activity);
                        activityList.appendChild(activityItem);
                    });
                    
                    // Hide load more button if all activities are shown
                    if (currentCount + nextActivities.length >= filteredActivities.length) {
                        document.getElementById('activity-load-more').style.display = 'none';
                    }
                };
            } else {
                document.getElementById('activity-load-more').style.display = 'none';
            }
            
            // If this is a forced refresh, sync with Baserow
            if (forceRefresh) {
                syncActivitiesWithBaserow();
            }
        }
        
        // Create an activity item element
        function createActivityItem(activity) {
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
            
            // Format timestamp
            const timestamp = new Date(activity.timestamp);
            const formattedDate = timestamp.toLocaleDateString();
            const formattedTime = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Determine activity title, details, and status
            let title = 'Activity';
            let details = '';
            let status = '';
            
            // Process different activity types
            switch (activity.type) {
                case 'page_view':
                    title = `Viewed ${activity.page || 'page'}`;
                    details = activity.details || '';
                    break;
                    
                case 'withdrawal_request':
                case 'form_submission':
                    title = 'Withdrawal Request';
                    
                    if (activity.details) {
                        if (typeof activity.details === 'object') {
                            const amount = activity.details.amount || '0.00';
                            const method = activity.details.paymentMethod || '';
                            details = `Amount: $${amount} USD via ${method}`;
                            
                            if (activity.details.status === 'success') {
                                status = '<div class="activity-status success">Success</div>';
                            } else if (activity.details.status === 'rejected' || activity.details.status === 'investment_required') {
                                status = '<div class="activity-status failed">Failed</div>';
                                details += `<br>Reason: ${activity.details.reason || 'Unknown'}`;
                            }
                        } else {
                            details = activity.details;
                        }
                    }
                    break;
                    
                case 'investment_attempt':
                    title = 'Investment Attempt';
                    
                    if (activity.planTitle) {
                        const amount = activity.totalAmount || '0.00';
                        details = `Plan: ${activity.planTitle}, Amount: $${amount} USD`;
                        
                        if (activity.success) {
                            status = '<div class="activity-status success">Success</div>';
                        } else {
                            status = '<div class="activity-status failed">Failed</div>';
                            if (activity.reason) {
                                details += `<br>Reason: ${activity.reason}`;
                            }
                        }
                    }
                    break;
                    
                case 'investment_processing':
                    title = 'Investment Processing';
                    
                    if (activity.planTitle) {
                        details = `Plan: ${activity.planTitle}, Amount: $${activity.amount} USD`;
                        status = '<div class="activity-status pending">Processing</div>';
                    }
                    break;
                    
                case 'authentication':
                case 'authentication_check':
                    title = 'Authentication';
                    
                    if (activity.status === 'success') {
                        details = 'Successfully authenticated';
                        status = '<div class="activity-status success">Success</div>';
                    } else {
                        details = activity.details || 'Authentication failed';
                        status = '<div class="activity-status failed">Failed</div>';
                    }
                    break;
                    
                case 'ui_interaction':
                    title = 'User Interaction';
                    
                    if (activity.action) {
                        details = `Action: ${activity.action}`;
                        if (activity.details) {
                            details += `<br>${activity.details}`;
                        }
                    }
                    break;
                    
                case 'plan_view':
                    title = 'Viewed Investment Plan';
                    
                    if (activity.planTitle) {
                        details = `Plan: ${activity.planTitle}, Price: $${activity.planPrice} USD`;
                    }
                    break;
                    
                case 'balance_update_success':
                    title = 'Balance Updated';
                    details = `Old Balance: $${activity.oldBalance} USD, New Balance: $${activity.newBalance} USD`;
                    status = '<div class="activity-status success">Success</div>';
                    break;
                    
                case 'error':
                    title = 'Error Occurred';
                    details = activity.details || 'An error occurred';
                    status = '<div class="activity-status failed">Error</div>';
                    break;
                    
                default:
                    title = activity.type ? activity.type.replace(/_/g, ' ') : 'Activity';
                    title = title.charAt(0).toUpperCase() + title.slice(1);
                    
                    if (activity.details) {
                        if (typeof activity.details === 'object') {
                            details = JSON.stringify(activity.details);
                        } else {
                            details = activity.details;
                        }
                    }
            }
            
            activityItem.innerHTML = `
                <div class="activity-time">${formattedDate} ${formattedTime}</div>
                <div class="activity-title">${title}</div>
                <div class="activity-details">${details}</div>
                ${status}
            `;
            
            return activityItem;
        }
        
        // Set up activity filters
        function setupActivityFilters() {
            document.querySelectorAll('.activity-filter').forEach(filter => {
                filter.addEventListener('click', function() {
                    // Remove active class from all filters
                    document.querySelectorAll('.activity-filter').forEach(f => {
                        f.classList.remove('active');
                    });
                    
                    // Add active class to clicked filter
                    this.classList.add('active');
                    
                    // Reload activity history with new filter
                    loadActivityHistory();
                });
            });
        }
        
        // Set up activity export
        function setupActivityExport() {
            document.getElementById('activity-export').addEventListener('click', function() {
                const activities = JSON.parse(localStorage.getItem(USER_ACTIVITY_KEY) || '[]');
                
                if (activities.length === 0) {
                    alert('No activities to export.');
                    return;
                }
                
                // Create CSV content
                let csvContent = 'data:text/csv;charset=utf-8,';
                csvContent += 'Date,Time,Type,Page,Details\n';
                
                activities.forEach(activity => {
                    const timestamp = new Date(activity.timestamp);
                    const date = timestamp.toLocaleDateString();
                    const time = timestamp.toLocaleTimeString();
                    
                    let details = '';
                    if (activity.details) {
                        if (typeof activity.details === 'object') {
                            details = JSON.stringify(activity.details).replace(/"/g, '""');
                        } else {
                            details = activity.details.replace(/"/g, '""');
                        }
                    }
                    
                    csvContent += `${date},${time},${activity.type || ''},${activity.page || ''},"${details}"\n`;
                });
                
                // Create download link
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', `activity_history_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                
                // Trigger download
                link.click();
                
                // Clean up
                document.body.removeChild(link);
            });
        }
        
        // Clean up old activities (older than 7 days)
        function cleanupOldActivities() {
            const activities = JSON.parse(localStorage.getItem(USER_ACTIVITY_KEY) || '[]');
            
            // Filter activities to only keep those from the last 7 days
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - ACTIVITY_RETENTION_DAYS);
            
            const recentActivities = activities.filter(activity => {
                const activityDate = new Date(activity.timestamp);
                return activityDate >= sevenDaysAgo;
            });
            
            // Save filtered activities back to localStorage
            if (recentActivities.length !== activities.length) {
                localStorage.setItem(USER_ACTIVITY_KEY, JSON.stringify(recentActivities));
                console.log(`Cleaned up ${activities.length - recentActivities.length} old activities.`);
            }
        }
        
        // Sync activities with Baserow
        async function syncActivitiesWithBaserow() {
            try {
                const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                if (!userData.email) {
                    console.error('No user email found for syncing activities');
                    return;
                }
                
                const activities = JSON.parse(localStorage.getItem(USER_ACTIVITY_KEY) || '[]');
                if (activities.length === 0) {
                    console.log('No activities to sync');
                    return;
                }
                
                console.log('Syncing activities with Baserow...');
                
                // Get field structure for activity table
                const fieldsResponse = await fetch(`${BASEROW_API.baseUrl}/database/fields/table/${BASEROW_API.activityTableId}/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${BASEROW_API.token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const fieldsData = await fieldsResponse.json();
                
                // Create a mapping of field names to their IDs
                const fieldMap = {};
                fieldsData.forEach(field => {
                    fieldMap[field.name] = field.id;
                });
                
                console.log('Activity table field mapping:', fieldMap);
                
                // Check if required fields exist
                const requiredFields = ['user_email', 'activity_type', 'activity_details', 'timestamp', 'page'];
                const missingFields = requiredFields.filter(field => !fieldMap[field]);
                
                if (missingFields.length > 0) {
                    console.error('Missing required fields in activity table:', missingFields);
                    return;
                }
                
                // Prepare activities for batch upload
                const activitiesToSync = activities.slice(0, 50); // Limit to 50 most recent activities
                
                // Create rows for each activity
                for (const activity of activitiesToSync) {
                    const rowData = {};
                    
                    // Set user email
                    rowData[`field_${fieldMap['user_email']}`] = userData.email;
                    
                    // Set activity type
                    rowData[`field_${fieldMap['activity_type']}`] = activity.type || 'unknown';
                    
                    // Set activity details
                    if (activity.details) {
                        if (typeof activity.details === 'object') {
                            rowData[`field_${fieldMap['activity_details']}`] = JSON.stringify(activity.details);
                        } else {
                            rowData[`field_${fieldMap['activity_details']}`] = activity.details;
                        }
                    } else {
                        rowData[`field_${fieldMap['activity_details']}`] = '';
                    }
                    
                    // Set timestamp
                    rowData[`field_${fieldMap['timestamp']}`] = activity.timestamp || new Date().toISOString();
                    
                    // Set page
                    rowData[`field_${fieldMap['page']}`] = activity.page || '';
                    
                    // Create row in Baserow
                    try {
                        const createResponse = await fetch(`${BASEROW_API.baseUrl}/database/rows/table/${BASEROW_API.activityTableId}/`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Token ${BASEROW_API.token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(rowData)
                        });
                        
                        if (!createResponse.ok) {
                            console.error('Failed to create activity row:', await createResponse.text());
                        }
                    } catch (error) {
                        console.error('Error creating activity row:', error);
                    }
                }
                
                console.log('Activity sync completed');
            } catch (error) {
                console.error('Error syncing activities with Baserow:', error);
            }
        }
    </script>
</body>
</html>
